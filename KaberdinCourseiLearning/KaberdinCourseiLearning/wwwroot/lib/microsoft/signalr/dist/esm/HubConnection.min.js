var r=this&&this.__awaiter||function(n,t,i,r){return new(i||(i=Promise))(function(u,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?u(n.value):new i(function(t){t(n.value)}).then(o,s)}e((r=r.apply(n,t||[])).next())})},u=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},e,o,t,s;import{HandshakeProtocol as h}from"./HandshakeProtocol";import{MessageType as i}from"./IHubProtocol";import{LogLevel as n}from"./ILogger";import{Subject as c}from"./Subject";import{Arg as f}from"./Utils";e=3e4;o=15e3;export*;(function(n){n.Disconnected="Disconnected";n.Connecting="Connecting";n.Connected="Connected";n.Disconnecting="Disconnecting";n.Reconnecting="Reconnecting"})(t||(t={}));s=function(){function s(n,r,u,s){var c=this;f.isRequired(n,"connection");f.isRequired(r,"logger");f.isRequired(u,"protocol");this.serverTimeoutInMilliseconds=e;this.keepAliveIntervalInMilliseconds=o;this.logger=r;this.protocol=u;this.connection=n;this.reconnectPolicy=s;this.handshakeProtocol=new h;this.connection.onreceive=function(n){return c.processIncomingData(n)};this.connection.onclose=function(n){return c.connectionClosed(n)};this.callbacks={};this.methods={};this.closedCallbacks=[];this.reconnectingCallbacks=[];this.reconnectedCallbacks=[];this.invocationId=0;this.receivedHandshakeResponse=!1;this.connectionState=t.Disconnected;this.connectionStarted=!1;this.cachedPingMessage=this.protocol.writeMessage({type:i.Ping})}return s.create=function(n,t,i,r){return new s(n,t,i,r)},Object.defineProperty(s.prototype,"state",{get:function(){return this.connectionState},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"connectionId",{get:function(){return this.connection?this.connection.connectionId||null:null},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"baseUrl",{get:function(){return this.connection.baseUrl||""},set:function(n){if(this.connectionState!==t.Disconnected&&this.connectionState!==t.Reconnecting)throw new Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!n)throw new Error("The HubConnection url must be a valid url.");this.connection.baseUrl=n},enumerable:!0,configurable:!0}),s.prototype.start=function(){return this.startPromise=this.startWithStateTransitions(),this.startPromise},s.prototype.startWithStateTransitions=function(){return r(this,void 0,void 0,function(){var i;return u(this,function(r){switch(r.label){case 0:if(this.connectionState!==t.Disconnected)return[2,Promise.reject(new Error("Cannot start a HubConnection that is not in the 'Disconnected' state."))];this.connectionState=t.Connecting;this.logger.log(n.Debug,"Starting HubConnection.");r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.startInternal()];case 2:return r.sent(),this.connectionState=t.Connected,this.connectionStarted=!0,this.logger.log(n.Debug,"HubConnection connected successfully."),[3,4];case 3:return i=r.sent(),this.connectionState=t.Disconnected,this.logger.log(n.Debug,"HubConnection failed to start successfully because of error '"+i+"'."),[2,Promise.reject(i)];case 4:return[2]}})})},s.prototype.startInternal=function(){return r(this,void 0,void 0,function(){var i,r,t,f=this;return u(this,function(u){switch(u.label){case 0:return this.stopDuringStartError=undefined,this.receivedHandshakeResponse=!1,i=new Promise(function(n,t){f.handshakeResolver=n;f.handshakeRejecter=t}),[4,this.connection.start(this.protocol.transferFormat)];case 1:u.sent();u.label=2;case 2:return u.trys.push([2,5,,7]),r={protocol:this.protocol.name,version:this.protocol.version},this.logger.log(n.Debug,"Sending handshake request."),[4,this.sendMessage(this.handshakeProtocol.writeHandshakeRequest(r))];case 3:return u.sent(),this.logger.log(n.Information,"Using HubProtocol '"+this.protocol.name+"'."),this.cleanupTimeout(),this.resetTimeoutPeriod(),this.resetKeepAliveInterval(),[4,i];case 4:if(u.sent(),this.stopDuringStartError)throw this.stopDuringStartError;return[3,7];case 5:return t=u.sent(),this.logger.log(n.Debug,"Hub handshake failed with error '"+t+"' during start(). Stopping HubConnection."),this.cleanupTimeout(),this.cleanupPingTimer(),[4,this.connection.stop(t)];case 6:u.sent();throw t;case 7:return[2]}})})},s.prototype.stop=function(){return r(this,void 0,void 0,function(){var n,t;return u(this,function(i){switch(i.label){case 0:return n=this.startPromise,this.stopPromise=this.stopInternal(),[4,this.stopPromise];case 1:i.sent();i.label=2;case 2:return i.trys.push([2,4,,5]),[4,n];case 3:return i.sent(),[3,5];case 4:return t=i.sent(),[3,5];case 5:return[2]}})})},s.prototype.stopInternal=function(i){return this.connectionState===t.Disconnected?(this.logger.log(n.Debug,"Call to HubConnection.stop("+i+") ignored because it is already in the disconnected state."),Promise.resolve()):this.connectionState===t.Disconnecting?(this.logger.log(n.Debug,"Call to HttpConnection.stop("+i+") ignored because the connection is already in the disconnecting state."),this.stopPromise):(this.connectionState=t.Disconnecting,this.logger.log(n.Debug,"Stopping HubConnection."),this.reconnectDelayHandle)?(this.logger.log(n.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this.reconnectDelayHandle),this.reconnectDelayHandle=undefined,this.completeClose(),Promise.resolve()):(this.cleanupTimeout(),this.cleanupPingTimer(),this.stopDuringStartError=i||new Error("The connection was stopped before the hub handshake could complete."),this.connection.stop(i))},s.prototype.stream=function(n){for(var u=this,e=[],f=1;f<arguments.length;f++)e[f-1]=arguments[f];var s=this.replaceStreamingParams(e),h=s[0],l=s[1],r=this.createStreamInvocation(n,e,l),o,t=new c;return t.cancelCallback=function(){var n=u.createCancelInvocation(r.invocationId);return delete u.callbacks[r.invocationId],o.then(function(){return u.sendWithProtocol(n)})},this.callbacks[r.invocationId]=function(n,r){if(r){t.error(r);return}n&&(n.type===i.Completion?n.error?t.error(new Error(n.error)):t.complete():t.next(n.item))},o=this.sendWithProtocol(r).catch(function(n){t.error(n);delete u.callbacks[r.invocationId]}),this.launchStreams(h,o),t},s.prototype.sendMessage=function(n){return this.resetKeepAliveInterval(),this.connection.send(n)},s.prototype.sendWithProtocol=function(n){return this.sendMessage(this.protocol.writeMessage(n))},s.prototype.send=function(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];var r=this.replaceStreamingParams(i),f=r[0],e=r[1],u=this.sendWithProtocol(this.createInvocation(n,i,!0,e));return this.launchStreams(f,u),u},s.prototype.invoke=function(n){for(var t=this,u=[],r=1;r<arguments.length;r++)u[r-1]=arguments[r];var e=this.replaceStreamingParams(u),o=e[0],s=e[1],f=this.createInvocation(n,u,!1,s);return new Promise(function(n,r){t.callbacks[f.invocationId]=function(t,u){if(u){r(u);return}t&&(t.type===i.Completion?t.error?r(new Error(t.error)):n(t.result):r(new Error("Unexpected message type: "+t.type)))};var u=t.sendWithProtocol(f).catch(function(n){r(n);delete t.callbacks[f.invocationId]});t.launchStreams(o,u)})},s.prototype.on=function(n,t){n&&t&&(n=n.toLowerCase(),this.methods[n]||(this.methods[n]=[]),this.methods[n].indexOf(t)===-1)&&this.methods[n].push(t)},s.prototype.off=function(n,t){var i,r;n&&(n=n.toLowerCase(),i=this.methods[n],i)&&(t?(r=i.indexOf(t),r!==-1&&(i.splice(r,1),i.length===0&&delete this.methods[n])):delete this.methods[n])},s.prototype.onclose=function(n){n&&this.closedCallbacks.push(n)},s.prototype.onreconnecting=function(n){n&&this.reconnectingCallbacks.push(n)},s.prototype.onreconnected=function(n){n&&this.reconnectedCallbacks.push(n)},s.prototype.processIncomingData=function(t){var s,u,f,r,e,o;if(this.cleanupTimeout(),this.receivedHandshakeResponse||(t=this.processHandshakeResponse(t),this.receivedHandshakeResponse=!0),t)for(s=this.protocol.parseMessages(t,this.logger),u=0,f=s;u<f.length;u++){r=f[u];switch(r.type){case i.Invocation:this.invokeClientMethod(r);break;case i.StreamItem:case i.Completion:e=this.callbacks[r.invocationId];e&&(r.type===i.Completion&&delete this.callbacks[r.invocationId],e(r));break;case i.Ping:break;case i.Close:this.logger.log(n.Information,"Close message received from server.");o=r.error?new Error("Server returned an error on close: "+r.error):undefined;r.allowReconnect===!0?this.connection.stop(o):this.stopPromise=this.stopInternal(o);break;default:this.logger.log(n.Warning,"Invalid message type: "+r.type+".")}}this.resetTimeoutPeriod()},s.prototype.processHandshakeResponse=function(t){var u,f,e,i,r;try{u=this.handshakeProtocol.parseHandshakeResponse(t);e=u[0];f=u[1]}catch(o){i="Error parsing handshake response: "+o;this.logger.log(n.Error,i);r=new Error(i);this.handshakeRejecter(r);throw r;}if(f.error){i="Server returned handshake error: "+f.error;this.logger.log(n.Error,i);r=new Error(i);this.handshakeRejecter(r);throw r;}else this.logger.log(n.Debug,"Server handshake complete.");return this.handshakeResolver(),e},s.prototype.resetKeepAliveInterval=function(){var n=this;this.connection.features.inherentKeepAlive||(this.cleanupPingTimer(),this.pingServerHandle=setTimeout(function(){return r(n,void 0,void 0,function(){var n;return u(this,function(i){switch(i.label){case 0:if(!(this.connectionState===t.Connected))return[3,4];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.sendMessage(this.cachedPingMessage)];case 2:return i.sent(),[3,4];case 3:return n=i.sent(),this.cleanupPingTimer(),[3,4];case 4:return[2]}})})},this.keepAliveIntervalInMilliseconds))},s.prototype.resetTimeoutPeriod=function(){var n=this;this.connection.features&&this.connection.features.inherentKeepAlive||(this.timeoutHandle=setTimeout(function(){return n.serverTimeout()},this.serverTimeoutInMilliseconds))},s.prototype.serverTimeout=function(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))},s.prototype.invokeClientMethod=function(t){var u=this,r=this.methods[t.target.toLowerCase()],i;if(r){try{r.forEach(function(n){return n.apply(u,t.arguments)})}catch(f){this.logger.log(n.Error,"A callback for the method "+t.target.toLowerCase()+" threw error '"+f+"'.")}t.invocationId&&(i="Server requested a response, which is not supported in this version of the client.",this.logger.log(n.Error,i),this.stopPromise=this.stopInternal(new Error(i)))}else this.logger.log(n.Warning,"No client method with the name '"+t.target+"' found.")},s.prototype.connectionClosed=function(i){this.logger.log(n.Debug,"HubConnection.connectionClosed("+i+") called while in state "+this.connectionState+".");this.stopDuringStartError=this.stopDuringStartError||i||new Error("The underlying connection was closed before the hub handshake could complete.");this.handshakeResolver&&this.handshakeResolver();this.cancelCallbacksWithError(i||new Error("Invocation canceled due to the underlying connection being closed."));this.cleanupTimeout();this.cleanupPingTimer();this.connectionState===t.Disconnecting?this.completeClose(i):this.connectionState===t.Connected&&this.reconnectPolicy?this.reconnect(i):this.connectionState===t.Connected&&this.completeClose(i)},s.prototype.completeClose=function(i){var r=this;if(this.connectionStarted){this.connectionState=t.Disconnected;this.connectionStarted=!1;try{this.closedCallbacks.forEach(function(n){return n.apply(r,[i])})}catch(u){this.logger.log(n.Error,"An onclose callback called with error '"+i+"' threw error '"+u+"'.")}}},s.prototype.reconnect=function(i){return r(this,void 0,void 0,function(){var h,f,o,r,e,s=this;return u(this,function(u){switch(u.label){case 0:if(h=Date.now(),f=0,o=i!==undefined?i:new Error("Attempting to reconnect due to a unknown error."),r=this.getNextRetryDelay(f++,0,o),r===null)return this.logger.log(n.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this.completeClose(i),[2];if(this.connectionState=t.Reconnecting,i?this.logger.log(n.Information,"Connection reconnecting because of error '"+i+"'."):this.logger.log(n.Information,"Connection reconnecting."),this.onreconnecting){try{this.reconnectingCallbacks.forEach(function(n){return n.apply(s,[i])})}catch(c){this.logger.log(n.Error,"An onreconnecting callback called with error '"+i+"' threw error '"+c+"'.")}if(this.connectionState!==t.Reconnecting)return this.logger.log(n.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting."),[2]}u.label=1;case 1:return(r!==null)?(this.logger.log(n.Information,"Reconnect attempt number "+f+" will start in "+r+" ms."),[4,new Promise(function(n){s.reconnectDelayHandle=setTimeout(n,r)})]):[3,7];case 2:if(u.sent(),this.reconnectDelayHandle=undefined,this.connectionState!==t.Reconnecting)return this.logger.log(n.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting."),[2];u.label=3;case 3:return u.trys.push([3,5,,6]),[4,this.startInternal()];case 4:if(u.sent(),this.connectionState=t.Connected,this.logger.log(n.Information,"HubConnection reconnected successfully."),this.onreconnected)try{this.reconnectedCallbacks.forEach(function(n){return n.apply(s,[s.connection.connectionId])})}catch(c){this.logger.log(n.Error,"An onreconnected callback called with connectionId '"+this.connection.connectionId+"; threw error '"+c+"'.")}return[2];case 5:return(e=u.sent(),this.logger.log(n.Information,"Reconnect attempt failed because of error '"+e+"'."),this.connectionState!==t.Reconnecting)?(this.logger.log(n.Debug,"Connection left the reconnecting state during reconnect attempt. Done reconnecting."),[2]):(o=e instanceof Error?e:new Error(e.toString()),r=this.getNextRetryDelay(f++,Date.now()-h,o),[3,6]);case 6:return[3,1];case 7:return this.logger.log(n.Information,"Reconnect retries have been exhausted after "+(Date.now()-h)+" ms and "+f+" failed attempts. Connection disconnecting."),this.completeClose(),[2]}})})},s.prototype.getNextRetryDelay=function(t,i,r){try{return this.reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:i,previousRetryCount:t,retryReason:r})}catch(u){return this.logger.log(n.Error,"IRetryPolicy.nextRetryDelayInMilliseconds("+t+", "+i+") threw error '"+u+"'."),null}},s.prototype.cancelCallbacksWithError=function(n){var t=this.callbacks;this.callbacks={};Object.keys(t).forEach(function(i){var r=t[i];r(null,n)})},s.prototype.cleanupPingTimer=function(){this.pingServerHandle&&clearTimeout(this.pingServerHandle)},s.prototype.cleanupTimeout=function(){this.timeoutHandle&&clearTimeout(this.timeoutHandle)},s.prototype.createInvocation=function(n,t,r,u){if(r)return u.length!==0?{arguments:t,streamIds:u,target:n,type:i.Invocation}:{arguments:t,target:n,type:i.Invocation};var f=this.invocationId;return this.invocationId++,u.length!==0?{arguments:t,invocationId:f.toString(),streamIds:u,target:n,type:i.Invocation}:{arguments:t,invocationId:f.toString(),target:n,type:i.Invocation}},s.prototype.launchStreams=function(n,t){var i=this,r,u;if(n.length!==0){t||(t=Promise.resolve());r=function(r){n[r].subscribe({complete:function(){t=t.then(function(){return i.sendWithProtocol(i.createCompletionMessage(r))})},error:function(n){var u;u=n instanceof Error?n.message:n&&n.toString?n.toString():"Unknown error";t=t.then(function(){return i.sendWithProtocol(i.createCompletionMessage(r,u))})},next:function(n){t=t.then(function(){return i.sendWithProtocol(i.createStreamItemMessage(r,n))})}})};for(u in n)r(u)}},s.prototype.replaceStreamingParams=function(n){for(var i,r,u=[],f=[],t=0;t<n.length;t++)i=n[t],this.isObservable(i)&&(r=this.invocationId,this.invocationId++,u[r]=i,f.push(r.toString()),n.splice(t,1));return[u,f]},s.prototype.isObservable=function(n){return n&&n.subscribe&&typeof n.subscribe=="function"},s.prototype.createStreamInvocation=function(n,t,r){var u=this.invocationId;return this.invocationId++,r.length!==0?{arguments:t,invocationId:u.toString(),streamIds:r,target:n,type:i.StreamInvocation}:{arguments:t,invocationId:u.toString(),target:n,type:i.StreamInvocation}},s.prototype.createCancelInvocation=function(n){return{invocationId:n,type:i.CancelInvocation}},s.prototype.createStreamItemMessage=function(n,t){return{invocationId:n,item:t,type:i.StreamItem}},s.prototype.createCompletionMessage=function(n,t,r){return t?{error:t,invocationId:n,type:i.Completion}:{invocationId:n,result:r,type:i.Completion}},s}();export{s as HubConnection};