function k(n,t){return!n||(t&n)!=0}var a=this&&this.__assign||Object.assign||function(n){for(var t,r,i=1,u=arguments.length;i<u;i++){t=arguments[i];for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},r=this&&this.__awaiter||function(n,t,i,r){return new(i||(i=Promise))(function(u,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?u(n.value):new i(function(t){t(n.value)}).then(o,s)}e((r=r.apply(n,t||[])).next())})},i=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},o,l,s,e;import{DefaultHttpClient as v}from"./DefaultHttpClient";import{LogLevel as n}from"./ILogger";import{HttpTransportType as t,TransferFormat as u}from"./ITransport";import{LongPollingTransport as h}from"./LongPollingTransport";import{ServerSentEventsTransport as y}from"./ServerSentEventsTransport";import{Arg as c,createLogger as p,getUserAgentHeader as w,Platform as f}from"./Utils";import{WebSocketTransport as b}from"./WebSocketTransport";o=100;l=function(){function e(n,t){var i,r,u;if(t===void 0&&(t={}),this.features={},this.negotiateVersion=1,c.isRequired(n,"url"),this.logger=p(t.logger),this.baseUrl=this.resolveUrl(n),t=t||{},t.logMessageContent=t.logMessageContent===undefined?!1:t.logMessageContent,typeof t.withCredentials=="boolean"||t.withCredentials===undefined)t.withCredentials=t.withCredentials===undefined?!0:t.withCredentials;else throw new Error("withCredentials option was not a 'boolean' or 'undefined' value");i=null;r=null;f.isNode&&typeof require!="undefined"&&(u=typeof __webpack_require__=="function"?__non_webpack_require__:require,i=u("ws"),r=u("eventsource"));f.isNode||typeof WebSocket=="undefined"||t.WebSocket?f.isNode&&!t.WebSocket&&i&&(t.WebSocket=i):t.WebSocket=WebSocket;f.isNode||typeof EventSource=="undefined"||t.EventSource?f.isNode&&!t.EventSource&&typeof r!="undefined"&&(t.EventSource=r):t.EventSource=EventSource;this.httpClient=t.httpClient||new v(this.logger);this.connectionState="Disconnected";this.connectionStarted=!1;this.options=t;this.onreceive=null;this.onclose=null}return e.prototype.start=function(t){return r(this,void 0,void 0,function(){var r;return i(this,function(i){switch(i.label){case 0:return(t=t||u.Binary,c.isIn(t,u,"transferFormat"),this.logger.log(n.Debug,"Starting connection with transfer format '"+u[t]+"'."),this.connectionState!=="Disconnected")?[2,Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."))]:(this.connectionState="Connecting",this.startInternalPromise=this.startInternal(t),[4,this.startInternalPromise]);case 1:return(i.sent(),!(this.connectionState==="Disconnecting"))?[3,3]:(r="Failed to start the HttpConnection before stop() was called.",this.logger.log(n.Error,r),[4,this.stopPromise]);case 2:return i.sent(),[2,Promise.reject(new Error(r))];case 3:if(this.connectionState!=="Connected")return r="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!",this.logger.log(n.Error,r),[2,Promise.reject(new Error(r))];i.label=4;case 4:return this.connectionStarted=!0,[2]}})})},e.prototype.send=function(n){return this.connectionState!=="Connected"?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this.sendQueue||(this.sendQueue=new s(this.transport)),this.sendQueue.send(n))},e.prototype.stop=function(t){return r(this,void 0,void 0,function(){var r=this;return i(this,function(i){switch(i.label){case 0:return this.connectionState==="Disconnected"?(this.logger.log(n.Debug,"Call to HttpConnection.stop("+t+") ignored because the connection is already in the disconnected state."),[2,Promise.resolve()]):this.connectionState==="Disconnecting"?(this.logger.log(n.Debug,"Call to HttpConnection.stop("+t+") ignored because the connection is already in the disconnecting state."),[2,this.stopPromise]):(this.connectionState="Disconnecting",this.stopPromise=new Promise(function(n){r.stopPromiseResolver=n}),[4,this.stopInternal(t)]);case 1:return i.sent(),[4,this.stopPromise];case 2:return i.sent(),[2]}})})},e.prototype.stopInternal=function(t){return r(this,void 0,void 0,function(){var u,r;return i(this,function(i){switch(i.label){case 0:this.stopError=t;i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.startInternalPromise];case 2:return i.sent(),[3,4];case 3:return u=i.sent(),[3,4];case 4:if(!this.transport)return[3,9];i.label=5;case 5:return i.trys.push([5,7,,8]),[4,this.transport.stop()];case 6:return i.sent(),[3,8];case 7:return r=i.sent(),this.logger.log(n.Error,"HttpConnection.transport.stop() threw error '"+r+"'."),this.stopConnection(),[3,8];case 8:return this.transport=undefined,[3,10];case 9:this.logger.log(n.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.");this.stopConnection();i.label=10;case 10:return[2]}})})},e.prototype.startInternal=function(u){return r(this,void 0,void 0,function(){var f,r,s,l,e,c;return i(this,function(a){switch(a.label){case 0:f=this.baseUrl;this.accessTokenFactory=this.options.accessTokenFactory;a.label=1;case 1:return(a.trys.push([1,12,,13]),!this.options.skipNegotiation)?[3,5]:(this.options.transport===t.WebSockets)?(this.transport=this.constructTransport(t.WebSockets),[4,this.startTransport(f,u)]):[3,3];case 2:return a.sent(),[3,4];case 3:throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");case 4:return[3,11];case 5:r=null;s=0;l=function(){var n;return i(this,function(t){switch(t.label){case 0:return[4,e.getNegotiationResponse(f)];case 1:if(r=t.sent(),e.connectionState==="Disconnecting"||e.connectionState==="Disconnected")throw new Error("The connection was stopped during negotiation.");if(r.error)throw new Error(r.error);if(r.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");return r.url&&(f=r.url),r.accessToken&&(n=r.accessToken,e.accessTokenFactory=function(){return n}),s++,[2]}})};e=this;a.label=6;case 6:return[5,l()];case 7:a.sent();a.label=8;case 8:if(r.url&&s<o)return[3,6];a.label=9;case 9:if(s===o&&r.url)throw new Error("Negotiate redirection limit exceeded.");return[4,this.createTransport(f,this.options.transport,r,u)];case 10:a.sent();a.label=11;case 11:return this.transport instanceof h&&(this.features.inherentKeepAlive=!0),this.connectionState==="Connecting"&&(this.logger.log(n.Debug,"The HttpConnection connected successfully."),this.connectionState="Connected"),[3,13];case 12:return c=a.sent(),this.logger.log(n.Error,"Failed to start the connection: "+c),this.connectionState="Disconnected",this.transport=undefined,[2,Promise.reject(c)];case 13:return[2]}})})},e.prototype.getNegotiationResponse=function(t){return r(this,void 0,void 0,function(){var u,e,o,c,l,s,f,r,h;return i(this,function(i){switch(i.label){case 0:return(u={},!this.accessTokenFactory)?[3,2]:[4,this.accessTokenFactory()];case 1:e=i.sent();e&&(u.Authorization="Bearer "+e);i.label=2;case 2:o=w();c=o[0];l=o[1];u[c]=l;s=this.resolveNegotiateUrl(t);this.logger.log(n.Debug,"Sending negotiation request: "+s+".");i.label=3;case 3:return i.trys.push([3,5,,6]),[4,this.httpClient.post(s,{content:"",headers:a({},u,this.options.headers),withCredentials:this.options.withCredentials})];case 4:return(f=i.sent(),f.statusCode!==200)?[2,Promise.reject(new Error("Unexpected status code returned from negotiate '"+f.statusCode+"'"))]:(r=JSON.parse(f.content),(!r.negotiateVersion||r.negotiateVersion<1)&&(r.connectionToken=r.connectionId),[2,r]);case 5:return h=i.sent(),this.logger.log(n.Error,"Failed to complete negotiation with the server: "+h),[2,Promise.reject(h)];case 6:return[2]}})})},e.prototype.createConnectUrl=function(n,t){return t?n+(n.indexOf("?")===-1?"?":"&")+("id="+t):n},e.prototype.createTransport=function(t,u,f,e){return r(this,void 0,void 0,function(){var c,o,p,r,l,a,s,h,w,v,y;return i(this,function(i){switch(i.label){case 0:return(c=this.createConnectUrl(t,f.connectionToken),!this.isITransport(u))?[3,2]:(this.logger.log(n.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=u,[4,this.startTransport(c,e)]);case 1:return i.sent(),this.connectionId=f.connectionId,[2];case 2:o=[];p=f.availableTransports||[];r=f;l=0;a=p;i.label=3;case 3:return(l<a.length)?(s=a[l],h=this.resolveTransportOrError(s,u,e),!(h instanceof Error))?[3,4]:(o.push(s.transport+" failed: "+h),[3,12]):[3,13];case 4:if(!this.isITransport(h))return[3,12];if(this.transport=h,!!r)return[3,9];i.label=5;case 5:return i.trys.push([5,7,,8]),[4,this.getNegotiationResponse(t)];case 6:return r=i.sent(),[3,8];case 7:return w=i.sent(),[2,Promise.reject(w)];case 8:c=this.createConnectUrl(t,r.connectionToken);i.label=9;case 9:return i.trys.push([9,11,,12]),[4,this.startTransport(c,e)];case 10:return i.sent(),this.connectionId=r.connectionId,[2];case 11:return(v=i.sent(),this.logger.log(n.Error,"Failed to start the transport '"+s.transport+"': "+v),r=undefined,o.push(s.transport+" failed: "+v),this.connectionState!=="Connecting")?(y="Failed to select transport before stop() was called.",this.logger.log(n.Debug,y),[2,Promise.reject(new Error(y))]):[3,12];case 12:return l++,[3,3];case 13:return o.length>0?[2,Promise.reject(new Error("Unable to connect to the server with any of the available transports. "+o.join(" ")))]:[2,Promise.reject(new Error("None of the transports supported by the client are supported by the server."))]}})})},e.prototype.constructTransport=function(n){switch(n){case t.WebSockets:if(!this.options.WebSocket)throw new Error("'WebSocket' is not supported in your environment.");return new b(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.WebSocket,this.options.headers||{});case t.ServerSentEvents:if(!this.options.EventSource)throw new Error("'EventSource' is not supported in your environment.");return new y(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.EventSource,this.options.withCredentials,this.options.headers||{});case t.LongPolling:return new h(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.withCredentials,this.options.headers||{});default:throw new Error("Unknown transport: "+n+".");}},e.prototype.startTransport=function(n,t){var i=this;return this.transport.onreceive=this.onreceive,this.transport.onclose=function(n){return i.stopConnection(n)},this.transport.connect(n,t)},e.prototype.resolveTransportOrError=function(i,r,f){var e=t[i.transport],o;if(e===null||e===undefined)return this.logger.log(n.Debug,"Skipping transport '"+i.transport+"' because it is not supported by this client."),new Error("Skipping transport '"+i.transport+"' because it is not supported by this client.");if(k(r,e))if(o=i.transferFormats.map(function(n){return u[n]}),o.indexOf(f)>=0)if((e!==t.WebSockets||this.options.WebSocket)&&(e!==t.ServerSentEvents||this.options.EventSource)){this.logger.log(n.Debug,"Selecting transport '"+t[e]+"'.");try{return this.constructTransport(e)}catch(s){return s}}else return this.logger.log(n.Debug,"Skipping transport '"+t[e]+"' because it is not supported in your environment.'"),new Error("'"+t[e]+"' is not supported in your environment.");else return this.logger.log(n.Debug,"Skipping transport '"+t[e]+"' because it does not support the requested transfer format '"+u[f]+"'."),new Error("'"+t[e]+"' does not support "+u[f]+".");else return this.logger.log(n.Debug,"Skipping transport '"+t[e]+"' because it was disabled by the client."),new Error("'"+t[e]+"' is disabled by the client.")},e.prototype.isITransport=function(n){return n&&typeof n=="object"&&"connect"in n},e.prototype.stopConnection=function(t){var i=this;if(this.logger.log(n.Debug,"HttpConnection.stopConnection("+t+") called while in state "+this.connectionState+"."),this.transport=undefined,t=this.stopError||t,this.stopError=undefined,this.connectionState==="Disconnected"){this.logger.log(n.Debug,"Call to HttpConnection.stopConnection("+t+") was ignored because the connection is already in the disconnected state.");return}if(this.connectionState==="Connecting"){this.logger.log(n.Warning,"Call to HttpConnection.stopConnection("+t+") was ignored because the connection is still in the connecting state.");throw new Error("HttpConnection.stopConnection("+t+") was called while the connection is still in the connecting state.");}if(this.connectionState==="Disconnecting"&&this.stopPromiseResolver(),t?this.logger.log(n.Error,"Connection disconnected with error '"+t+"'."):this.logger.log(n.Information,"Connection disconnected."),this.sendQueue&&(this.sendQueue.stop().catch(function(t){i.logger.log(n.Error,"TransportSendQueue.stop() threw error '"+t+"'.")}),this.sendQueue=undefined),this.connectionId=undefined,this.connectionState="Disconnected",this.connectionStarted){this.connectionStarted=!1;try{if(this.onclose)this.onclose(t)}catch(r){this.logger.log(n.Error,"HttpConnection.onclose("+t+") threw error '"+r+"'.")}}},e.prototype.resolveUrl=function(t){if(t.lastIndexOf("https://",0)===0||t.lastIndexOf("http://",0)===0)return t;if(!f.isBrowser||!window.document)throw new Error("Cannot resolve '"+t+"'.");var i=window.document.createElement("a");return i.href=t,this.logger.log(n.Information,"Normalizing '"+t+"' to '"+i.href+"'."),i.href},e.prototype.resolveNegotiateUrl=function(n){var i=n.indexOf("?"),t=n.substring(0,i===-1?n.length:i);return t[t.length-1]!=="/"&&(t+="/"),t+="negotiate",t+=i===-1?"":n.substring(i),t.indexOf("negotiateVersion")===-1&&(t+=i===-1?"?":"&",t+="negotiateVersion="+this.negotiateVersion),t},e}();s=function(){function n(n){this.transport=n;this.buffer=[];this.executing=!0;this.sendBufferedData=new e;this.transportResult=new e;this.sendLoopPromise=this.sendLoop()}return n.prototype.send=function(n){return this.bufferData(n),this.transportResult||(this.transportResult=new e),this.transportResult.promise},n.prototype.stop=function(){return this.executing=!1,this.sendBufferedData.resolve(),this.sendLoopPromise},n.prototype.bufferData=function(n){if(this.buffer.length&&typeof this.buffer[0]!=typeof n)throw new Error("Expected data to be of type "+typeof this.buffer+" but was of type "+typeof n);this.buffer.push(n);this.sendBufferedData.resolve()},n.prototype.sendLoop=function(){return r(this,void 0,void 0,function(){var t,r,u;return i(this,function(i){switch(i.label){case 0:return[4,this.sendBufferedData.promise];case 1:if(i.sent(),!this.executing)return this.transportResult&&this.transportResult.reject("Connection stopped."),[3,6];this.sendBufferedData=new e;t=this.transportResult;this.transportResult=undefined;r=typeof this.buffer[0]=="string"?this.buffer.join(""):n.concatBuffers(this.buffer);this.buffer.length=0;i.label=2;case 2:return i.trys.push([2,4,,5]),[4,this.transport.send(r)];case 3:return i.sent(),t.resolve(),[3,5];case 4:return u=i.sent(),t.reject(u),[3,5];case 5:return[3,0];case 6:return[2]}})})},n.concatBuffers=function(n){for(var i,e=n.map(function(n){return n.byteLength}).reduce(function(n,t){return n+t}),r=new Uint8Array(e),u=0,t=0,f=n;t<f.length;t++)i=f[t],r.set(new Uint8Array(i),u),u+=i.byteLength;return r.buffer},n}();e=function(){function n(){var n=this;this.promise=new Promise(function(t,i){var r;return r=[t,i],n.resolver=r[0],n.rejecter=r[1],r})}return n.prototype.resolve=function(){this.resolver()},n.prototype.reject=function(n){this.rejecter(n)},n}();export{l as HttpConnection,s as TransportSendQueue};