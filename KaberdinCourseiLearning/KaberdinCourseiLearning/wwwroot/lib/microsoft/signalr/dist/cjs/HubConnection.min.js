"use strict";var __awaiter=this&&this.__awaiter||function(n,t,i,r){return new(i||(i=Promise))(function(u,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?u(n.value):new i(function(t){t(n.value)}).then(o,s)}e((r=r.apply(n,t||[])).next())})},__generator=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},HubConnection;Object.defineProperty(exports,"__esModule",{value:!0});var HandshakeProtocol_1=require("./HandshakeProtocol"),IHubProtocol_1=require("./IHubProtocol"),ILogger_1=require("./ILogger"),Subject_1=require("./Subject"),Utils_1=require("./Utils"),DEFAULT_TIMEOUT_IN_MS=3e4,DEFAULT_PING_INTERVAL_IN_MS=15e3,HubConnectionState;(function(n){n.Disconnected="Disconnected";n.Connecting="Connecting";n.Connected="Connected";n.Disconnecting="Disconnecting";n.Reconnecting="Reconnecting"})(HubConnectionState=exports.HubConnectionState||(exports.HubConnectionState={}));HubConnection=function(){function n(n,t,i,r){var u=this;Utils_1.Arg.isRequired(n,"connection");Utils_1.Arg.isRequired(t,"logger");Utils_1.Arg.isRequired(i,"protocol");this.serverTimeoutInMilliseconds=DEFAULT_TIMEOUT_IN_MS;this.keepAliveIntervalInMilliseconds=DEFAULT_PING_INTERVAL_IN_MS;this.logger=t;this.protocol=i;this.connection=n;this.reconnectPolicy=r;this.handshakeProtocol=new HandshakeProtocol_1.HandshakeProtocol;this.connection.onreceive=function(n){return u.processIncomingData(n)};this.connection.onclose=function(n){return u.connectionClosed(n)};this.callbacks={};this.methods={};this.closedCallbacks=[];this.reconnectingCallbacks=[];this.reconnectedCallbacks=[];this.invocationId=0;this.receivedHandshakeResponse=!1;this.connectionState=HubConnectionState.Disconnected;this.connectionStarted=!1;this.cachedPingMessage=this.protocol.writeMessage({type:IHubProtocol_1.MessageType.Ping})}return n.create=function(t,i,r,u){return new n(t,i,r,u)},Object.defineProperty(n.prototype,"state",{get:function(){return this.connectionState},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"connectionId",{get:function(){return this.connection?this.connection.connectionId||null:null},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"baseUrl",{get:function(){return this.connection.baseUrl||""},set:function(n){if(this.connectionState!==HubConnectionState.Disconnected&&this.connectionState!==HubConnectionState.Reconnecting)throw new Error("The HubConnection must be in the Disconnected or Reconnecting state to change the url.");if(!n)throw new Error("The HubConnection url must be a valid url.");this.connection.baseUrl=n},enumerable:!0,configurable:!0}),n.prototype.start=function(){return this.startPromise=this.startWithStateTransitions(),this.startPromise},n.prototype.startWithStateTransitions=function(){return __awaiter(this,void 0,void 0,function(){var n;return __generator(this,function(t){switch(t.label){case 0:if(this.connectionState!==HubConnectionState.Disconnected)return[2,Promise.reject(new Error("Cannot start a HubConnection that is not in the 'Disconnected' state."))];this.connectionState=HubConnectionState.Connecting;this.logger.log(ILogger_1.LogLevel.Debug,"Starting HubConnection.");t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.startInternal()];case 2:return t.sent(),this.connectionState=HubConnectionState.Connected,this.connectionStarted=!0,this.logger.log(ILogger_1.LogLevel.Debug,"HubConnection connected successfully."),[3,4];case 3:return n=t.sent(),this.connectionState=HubConnectionState.Disconnected,this.logger.log(ILogger_1.LogLevel.Debug,"HubConnection failed to start successfully because of error '"+n+"'."),[2,Promise.reject(n)];case 4:return[2]}})})},n.prototype.startInternal=function(){return __awaiter(this,void 0,void 0,function(){var t,i,n,r=this;return __generator(this,function(u){switch(u.label){case 0:return this.stopDuringStartError=undefined,this.receivedHandshakeResponse=!1,t=new Promise(function(n,t){r.handshakeResolver=n;r.handshakeRejecter=t}),[4,this.connection.start(this.protocol.transferFormat)];case 1:u.sent();u.label=2;case 2:return u.trys.push([2,5,,7]),i={protocol:this.protocol.name,version:this.protocol.version},this.logger.log(ILogger_1.LogLevel.Debug,"Sending handshake request."),[4,this.sendMessage(this.handshakeProtocol.writeHandshakeRequest(i))];case 3:return u.sent(),this.logger.log(ILogger_1.LogLevel.Information,"Using HubProtocol '"+this.protocol.name+"'."),this.cleanupTimeout(),this.resetTimeoutPeriod(),this.resetKeepAliveInterval(),[4,t];case 4:if(u.sent(),this.stopDuringStartError)throw this.stopDuringStartError;return[3,7];case 5:return n=u.sent(),this.logger.log(ILogger_1.LogLevel.Debug,"Hub handshake failed with error '"+n+"' during start(). Stopping HubConnection."),this.cleanupTimeout(),this.cleanupPingTimer(),[4,this.connection.stop(n)];case 6:u.sent();throw n;case 7:return[2]}})})},n.prototype.stop=function(){return __awaiter(this,void 0,void 0,function(){var n,t;return __generator(this,function(i){switch(i.label){case 0:return n=this.startPromise,this.stopPromise=this.stopInternal(),[4,this.stopPromise];case 1:i.sent();i.label=2;case 2:return i.trys.push([2,4,,5]),[4,n];case 3:return i.sent(),[3,5];case 4:return t=i.sent(),[3,5];case 5:return[2]}})})},n.prototype.stopInternal=function(n){return this.connectionState===HubConnectionState.Disconnected?(this.logger.log(ILogger_1.LogLevel.Debug,"Call to HubConnection.stop("+n+") ignored because it is already in the disconnected state."),Promise.resolve()):this.connectionState===HubConnectionState.Disconnecting?(this.logger.log(ILogger_1.LogLevel.Debug,"Call to HttpConnection.stop("+n+") ignored because the connection is already in the disconnecting state."),this.stopPromise):(this.connectionState=HubConnectionState.Disconnecting,this.logger.log(ILogger_1.LogLevel.Debug,"Stopping HubConnection."),this.reconnectDelayHandle)?(this.logger.log(ILogger_1.LogLevel.Debug,"Connection stopped during reconnect delay. Done reconnecting."),clearTimeout(this.reconnectDelayHandle),this.reconnectDelayHandle=undefined,this.completeClose(),Promise.resolve()):(this.cleanupTimeout(),this.cleanupPingTimer(),this.stopDuringStartError=n||new Error("The connection was stopped before the hub handshake could complete."),this.connection.stop(n))},n.prototype.stream=function(n){for(var r=this,f=[],u=1;u<arguments.length;u++)f[u-1]=arguments[u];var o=this.replaceStreamingParams(f),s=o[0],h=o[1],i=this.createStreamInvocation(n,f,h),e,t=new Subject_1.Subject;return t.cancelCallback=function(){var n=r.createCancelInvocation(i.invocationId);return delete r.callbacks[i.invocationId],e.then(function(){return r.sendWithProtocol(n)})},this.callbacks[i.invocationId]=function(n,i){if(i){t.error(i);return}n&&(n.type===IHubProtocol_1.MessageType.Completion?n.error?t.error(new Error(n.error)):t.complete():t.next(n.item))},e=this.sendWithProtocol(i).catch(function(n){t.error(n);delete r.callbacks[i.invocationId]}),this.launchStreams(s,e),t},n.prototype.sendMessage=function(n){return this.resetKeepAliveInterval(),this.connection.send(n)},n.prototype.sendWithProtocol=function(n){return this.sendMessage(this.protocol.writeMessage(n))},n.prototype.send=function(n){for(var i=[],t=1;t<arguments.length;t++)i[t-1]=arguments[t];var r=this.replaceStreamingParams(i),f=r[0],e=r[1],u=this.sendWithProtocol(this.createInvocation(n,i,!0,e));return this.launchStreams(f,u),u},n.prototype.invoke=function(n){for(var t=this,r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];var f=this.replaceStreamingParams(r),e=f[0],o=f[1],u=this.createInvocation(n,r,!1,o);return new Promise(function(n,i){t.callbacks[u.invocationId]=function(t,r){if(r){i(r);return}t&&(t.type===IHubProtocol_1.MessageType.Completion?t.error?i(new Error(t.error)):n(t.result):i(new Error("Unexpected message type: "+t.type)))};var r=t.sendWithProtocol(u).catch(function(n){i(n);delete t.callbacks[u.invocationId]});t.launchStreams(e,r)})},n.prototype.on=function(n,t){n&&t&&(n=n.toLowerCase(),this.methods[n]||(this.methods[n]=[]),this.methods[n].indexOf(t)===-1)&&this.methods[n].push(t)},n.prototype.off=function(n,t){var i,r;n&&(n=n.toLowerCase(),i=this.methods[n],i)&&(t?(r=i.indexOf(t),r!==-1&&(i.splice(r,1),i.length===0&&delete this.methods[n])):delete this.methods[n])},n.prototype.onclose=function(n){n&&this.closedCallbacks.push(n)},n.prototype.onreconnecting=function(n){n&&this.reconnectingCallbacks.push(n)},n.prototype.onreconnected=function(n){n&&this.reconnectedCallbacks.push(n)},n.prototype.processIncomingData=function(n){var e,i,r,t,u,f;if(this.cleanupTimeout(),this.receivedHandshakeResponse||(n=this.processHandshakeResponse(n),this.receivedHandshakeResponse=!0),n)for(e=this.protocol.parseMessages(n,this.logger),i=0,r=e;i<r.length;i++){t=r[i];switch(t.type){case IHubProtocol_1.MessageType.Invocation:this.invokeClientMethod(t);break;case IHubProtocol_1.MessageType.StreamItem:case IHubProtocol_1.MessageType.Completion:u=this.callbacks[t.invocationId];u&&(t.type===IHubProtocol_1.MessageType.Completion&&delete this.callbacks[t.invocationId],u(t));break;case IHubProtocol_1.MessageType.Ping:break;case IHubProtocol_1.MessageType.Close:this.logger.log(ILogger_1.LogLevel.Information,"Close message received from server.");f=t.error?new Error("Server returned an error on close: "+t.error):undefined;t.allowReconnect===!0?this.connection.stop(f):this.stopPromise=this.stopInternal(f);break;default:this.logger.log(ILogger_1.LogLevel.Warning,"Invalid message type: "+t.type+".")}}this.resetTimeoutPeriod()},n.prototype.processHandshakeResponse=function(n){var r,u,f,t,i;try{r=this.handshakeProtocol.parseHandshakeResponse(n);f=r[0];u=r[1]}catch(e){t="Error parsing handshake response: "+e;this.logger.log(ILogger_1.LogLevel.Error,t);i=new Error(t);this.handshakeRejecter(i);throw i;}if(u.error){t="Server returned handshake error: "+u.error;this.logger.log(ILogger_1.LogLevel.Error,t);i=new Error(t);this.handshakeRejecter(i);throw i;}else this.logger.log(ILogger_1.LogLevel.Debug,"Server handshake complete.");return this.handshakeResolver(),f},n.prototype.resetKeepAliveInterval=function(){var n=this;this.connection.features.inherentKeepAlive||(this.cleanupPingTimer(),this.pingServerHandle=setTimeout(function(){return __awaiter(n,void 0,void 0,function(){var n;return __generator(this,function(t){switch(t.label){case 0:if(!(this.connectionState===HubConnectionState.Connected))return[3,4];t.label=1;case 1:return t.trys.push([1,3,,4]),[4,this.sendMessage(this.cachedPingMessage)];case 2:return t.sent(),[3,4];case 3:return n=t.sent(),this.cleanupPingTimer(),[3,4];case 4:return[2]}})})},this.keepAliveIntervalInMilliseconds))},n.prototype.resetTimeoutPeriod=function(){var n=this;this.connection.features&&this.connection.features.inherentKeepAlive||(this.timeoutHandle=setTimeout(function(){return n.serverTimeout()},this.serverTimeoutInMilliseconds))},n.prototype.serverTimeout=function(){this.connection.stop(new Error("Server timeout elapsed without receiving a message from the server."))},n.prototype.invokeClientMethod=function(n){var r=this,i=this.methods[n.target.toLowerCase()],t;if(i){try{i.forEach(function(t){return t.apply(r,n.arguments)})}catch(u){this.logger.log(ILogger_1.LogLevel.Error,"A callback for the method "+n.target.toLowerCase()+" threw error '"+u+"'.")}n.invocationId&&(t="Server requested a response, which is not supported in this version of the client.",this.logger.log(ILogger_1.LogLevel.Error,t),this.stopPromise=this.stopInternal(new Error(t)))}else this.logger.log(ILogger_1.LogLevel.Warning,"No client method with the name '"+n.target+"' found.")},n.prototype.connectionClosed=function(n){this.logger.log(ILogger_1.LogLevel.Debug,"HubConnection.connectionClosed("+n+") called while in state "+this.connectionState+".");this.stopDuringStartError=this.stopDuringStartError||n||new Error("The underlying connection was closed before the hub handshake could complete.");this.handshakeResolver&&this.handshakeResolver();this.cancelCallbacksWithError(n||new Error("Invocation canceled due to the underlying connection being closed."));this.cleanupTimeout();this.cleanupPingTimer();this.connectionState===HubConnectionState.Disconnecting?this.completeClose(n):this.connectionState===HubConnectionState.Connected&&this.reconnectPolicy?this.reconnect(n):this.connectionState===HubConnectionState.Connected&&this.completeClose(n)},n.prototype.completeClose=function(n){var t=this;if(this.connectionStarted){this.connectionState=HubConnectionState.Disconnected;this.connectionStarted=!1;try{this.closedCallbacks.forEach(function(i){return i.apply(t,[n])})}catch(i){this.logger.log(ILogger_1.LogLevel.Error,"An onclose callback called with error '"+n+"' threw error '"+i+"'.")}}},n.prototype.reconnect=function(n){return __awaiter(this,void 0,void 0,function(){var e,i,u,t,r,f=this;return __generator(this,function(o){switch(o.label){case 0:if(e=Date.now(),i=0,u=n!==undefined?n:new Error("Attempting to reconnect due to a unknown error."),t=this.getNextRetryDelay(i++,0,u),t===null)return this.logger.log(ILogger_1.LogLevel.Debug,"Connection not reconnecting because the IRetryPolicy returned null on the first reconnect attempt."),this.completeClose(n),[2];if(this.connectionState=HubConnectionState.Reconnecting,n?this.logger.log(ILogger_1.LogLevel.Information,"Connection reconnecting because of error '"+n+"'."):this.logger.log(ILogger_1.LogLevel.Information,"Connection reconnecting."),this.onreconnecting){try{this.reconnectingCallbacks.forEach(function(t){return t.apply(f,[n])})}catch(s){this.logger.log(ILogger_1.LogLevel.Error,"An onreconnecting callback called with error '"+n+"' threw error '"+s+"'.")}if(this.connectionState!==HubConnectionState.Reconnecting)return this.logger.log(ILogger_1.LogLevel.Debug,"Connection left the reconnecting state in onreconnecting callback. Done reconnecting."),[2]}o.label=1;case 1:return(t!==null)?(this.logger.log(ILogger_1.LogLevel.Information,"Reconnect attempt number "+i+" will start in "+t+" ms."),[4,new Promise(function(n){f.reconnectDelayHandle=setTimeout(n,t)})]):[3,7];case 2:if(o.sent(),this.reconnectDelayHandle=undefined,this.connectionState!==HubConnectionState.Reconnecting)return this.logger.log(ILogger_1.LogLevel.Debug,"Connection left the reconnecting state during reconnect delay. Done reconnecting."),[2];o.label=3;case 3:return o.trys.push([3,5,,6]),[4,this.startInternal()];case 4:if(o.sent(),this.connectionState=HubConnectionState.Connected,this.logger.log(ILogger_1.LogLevel.Information,"HubConnection reconnected successfully."),this.onreconnected)try{this.reconnectedCallbacks.forEach(function(n){return n.apply(f,[f.connection.connectionId])})}catch(s){this.logger.log(ILogger_1.LogLevel.Error,"An onreconnected callback called with connectionId '"+this.connection.connectionId+"; threw error '"+s+"'.")}return[2];case 5:return(r=o.sent(),this.logger.log(ILogger_1.LogLevel.Information,"Reconnect attempt failed because of error '"+r+"'."),this.connectionState!==HubConnectionState.Reconnecting)?(this.logger.log(ILogger_1.LogLevel.Debug,"Connection left the reconnecting state during reconnect attempt. Done reconnecting."),[2]):(u=r instanceof Error?r:new Error(r.toString()),t=this.getNextRetryDelay(i++,Date.now()-e,u),[3,6]);case 6:return[3,1];case 7:return this.logger.log(ILogger_1.LogLevel.Information,"Reconnect retries have been exhausted after "+(Date.now()-e)+" ms and "+i+" failed attempts. Connection disconnecting."),this.completeClose(),[2]}})})},n.prototype.getNextRetryDelay=function(n,t,i){try{return this.reconnectPolicy.nextRetryDelayInMilliseconds({elapsedMilliseconds:t,previousRetryCount:n,retryReason:i})}catch(r){return this.logger.log(ILogger_1.LogLevel.Error,"IRetryPolicy.nextRetryDelayInMilliseconds("+n+", "+t+") threw error '"+r+"'."),null}},n.prototype.cancelCallbacksWithError=function(n){var t=this.callbacks;this.callbacks={};Object.keys(t).forEach(function(i){var r=t[i];r(null,n)})},n.prototype.cleanupPingTimer=function(){this.pingServerHandle&&clearTimeout(this.pingServerHandle)},n.prototype.cleanupTimeout=function(){this.timeoutHandle&&clearTimeout(this.timeoutHandle)},n.prototype.createInvocation=function(n,t,i,r){if(i)return r.length!==0?{arguments:t,streamIds:r,target:n,type:IHubProtocol_1.MessageType.Invocation}:{arguments:t,target:n,type:IHubProtocol_1.MessageType.Invocation};var u=this.invocationId;return this.invocationId++,r.length!==0?{arguments:t,invocationId:u.toString(),streamIds:r,target:n,type:IHubProtocol_1.MessageType.Invocation}:{arguments:t,invocationId:u.toString(),target:n,type:IHubProtocol_1.MessageType.Invocation}},n.prototype.launchStreams=function(n,t){var i=this,r,u;if(n.length!==0){t||(t=Promise.resolve());r=function(r){n[r].subscribe({complete:function(){t=t.then(function(){return i.sendWithProtocol(i.createCompletionMessage(r))})},error:function(n){var u;u=n instanceof Error?n.message:n&&n.toString?n.toString():"Unknown error";t=t.then(function(){return i.sendWithProtocol(i.createCompletionMessage(r,u))})},next:function(n){t=t.then(function(){return i.sendWithProtocol(i.createStreamItemMessage(r,n))})}})};for(u in n)r(u)}},n.prototype.replaceStreamingParams=function(n){for(var i,r,u=[],f=[],t=0;t<n.length;t++)i=n[t],this.isObservable(i)&&(r=this.invocationId,this.invocationId++,u[r]=i,f.push(r.toString()),n.splice(t,1));return[u,f]},n.prototype.isObservable=function(n){return n&&n.subscribe&&typeof n.subscribe=="function"},n.prototype.createStreamInvocation=function(n,t,i){var r=this.invocationId;return this.invocationId++,i.length!==0?{arguments:t,invocationId:r.toString(),streamIds:i,target:n,type:IHubProtocol_1.MessageType.StreamInvocation}:{arguments:t,invocationId:r.toString(),target:n,type:IHubProtocol_1.MessageType.StreamInvocation}},n.prototype.createCancelInvocation=function(n){return{invocationId:n,type:IHubProtocol_1.MessageType.CancelInvocation}},n.prototype.createStreamItemMessage=function(n,t){return{invocationId:n,item:t,type:IHubProtocol_1.MessageType.StreamItem}},n.prototype.createCompletionMessage=function(n,t,i){return t?{error:t,invocationId:n,type:IHubProtocol_1.MessageType.Completion}:{invocationId:n,result:i,type:IHubProtocol_1.MessageType.Completion}},n}();exports.HubConnection=HubConnection;