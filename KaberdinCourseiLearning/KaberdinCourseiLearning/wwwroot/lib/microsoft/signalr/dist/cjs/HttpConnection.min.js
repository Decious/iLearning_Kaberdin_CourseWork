"use strict";function transportMatches(n,t){return!n||(t&n)!=0}var __assign=this&&this.__assign||Object.assign||function(n){for(var t,r,i=1,u=arguments.length;i<u;i++){t=arguments[i];for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&(n[r]=t[r])}return n},__awaiter=this&&this.__awaiter||function(n,t,i,r){return new(i||(i=Promise))(function(u,f){function o(n){try{e(r.next(n))}catch(t){f(t)}}function s(n){try{e(r["throw"](n))}catch(t){f(t)}}function e(n){n.done?u(n.value):new i(function(t){t(n.value)}).then(o,s)}e((r=r.apply(n,t||[])).next())})},__generator=this&&this.__generator||function(n,t){function o(n){return function(t){return s([n,t])}}function s(e){if(f)throw new TypeError("Generator is already executing.");while(r)try{if(f=1,u&&(i=e[0]&2?u["return"]:e[0]?u["throw"]||((i=u["return"])&&i.call(u),0):u.next)&&!(i=i.call(u,e[1])).done)return i;(u=0,i)&&(e=[e[0]&2,i.value]);switch(e[0]){case 0:case 1:i=e;break;case 4:return r.label++,{value:e[1],done:!1};case 5:r.label++;u=e[1];e=[0];continue;case 7:e=r.ops.pop();r.trys.pop();continue;default:if(!(i=r.trys,i=i.length>0&&i[i.length-1])&&(e[0]===6||e[0]===2)){r=0;continue}if(e[0]===3&&(!i||e[1]>i[0]&&e[1]<i[3])){r.label=e[1];break}if(e[0]===6&&r.label<i[1]){r.label=i[1];i=e;break}if(i&&r.label<i[2]){r.label=i[2];r.ops.push(e);break}i[2]&&r.ops.pop();r.trys.pop();continue}e=t.call(n,r)}catch(o){e=[6,o];u=0}finally{f=i=0}if(e[0]&5)throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}var r={label:0,sent:function(){if(i[0]&1)throw i[1];return i[1]},trys:[],ops:[]},f,u,i,e;return e={next:o(0),"throw":o(1),"return":o(2)},typeof Symbol=="function"&&(e[Symbol.iterator]=function(){return this}),e},TransportSendQueue,PromiseSource;Object.defineProperty(exports,"__esModule",{value:!0});var DefaultHttpClient_1=require("./DefaultHttpClient"),ILogger_1=require("./ILogger"),ITransport_1=require("./ITransport"),LongPollingTransport_1=require("./LongPollingTransport"),ServerSentEventsTransport_1=require("./ServerSentEventsTransport"),Utils_1=require("./Utils"),WebSocketTransport_1=require("./WebSocketTransport"),MAX_REDIRECTS=100,HttpConnection=function(){function n(n,t){var i,r,u;if(t===void 0&&(t={}),this.features={},this.negotiateVersion=1,Utils_1.Arg.isRequired(n,"url"),this.logger=Utils_1.createLogger(t.logger),this.baseUrl=this.resolveUrl(n),t=t||{},t.logMessageContent=t.logMessageContent===undefined?!1:t.logMessageContent,typeof t.withCredentials=="boolean"||t.withCredentials===undefined)t.withCredentials=t.withCredentials===undefined?!0:t.withCredentials;else throw new Error("withCredentials option was not a 'boolean' or 'undefined' value");i=null;r=null;Utils_1.Platform.isNode&&typeof require!="undefined"&&(u=typeof __webpack_require__=="function"?__non_webpack_require__:require,i=u("ws"),r=u("eventsource"));Utils_1.Platform.isNode||typeof WebSocket=="undefined"||t.WebSocket?Utils_1.Platform.isNode&&!t.WebSocket&&i&&(t.WebSocket=i):t.WebSocket=WebSocket;Utils_1.Platform.isNode||typeof EventSource=="undefined"||t.EventSource?Utils_1.Platform.isNode&&!t.EventSource&&typeof r!="undefined"&&(t.EventSource=r):t.EventSource=EventSource;this.httpClient=t.httpClient||new DefaultHttpClient_1.DefaultHttpClient(this.logger);this.connectionState="Disconnected";this.connectionStarted=!1;this.options=t;this.onreceive=null;this.onclose=null}return n.prototype.start=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(i){switch(i.label){case 0:return(n=n||ITransport_1.TransferFormat.Binary,Utils_1.Arg.isIn(n,ITransport_1.TransferFormat,"transferFormat"),this.logger.log(ILogger_1.LogLevel.Debug,"Starting connection with transfer format '"+ITransport_1.TransferFormat[n]+"'."),this.connectionState!=="Disconnected")?[2,Promise.reject(new Error("Cannot start an HttpConnection that is not in the 'Disconnected' state."))]:(this.connectionState="Connecting",this.startInternalPromise=this.startInternal(n),[4,this.startInternalPromise]);case 1:return(i.sent(),!(this.connectionState==="Disconnecting"))?[3,3]:(t="Failed to start the HttpConnection before stop() was called.",this.logger.log(ILogger_1.LogLevel.Error,t),[4,this.stopPromise]);case 2:return i.sent(),[2,Promise.reject(new Error(t))];case 3:if(this.connectionState!=="Connected")return t="HttpConnection.startInternal completed gracefully but didn't enter the connection into the connected state!",this.logger.log(ILogger_1.LogLevel.Error,t),[2,Promise.reject(new Error(t))];i.label=4;case 4:return this.connectionStarted=!0,[2]}})})},n.prototype.send=function(n){return this.connectionState!=="Connected"?Promise.reject(new Error("Cannot send data if the connection is not in the 'Connected' State.")):(this.sendQueue||(this.sendQueue=new TransportSendQueue(this.transport)),this.sendQueue.send(n))},n.prototype.stop=function(n){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(i){switch(i.label){case 0:return this.connectionState==="Disconnected"?(this.logger.log(ILogger_1.LogLevel.Debug,"Call to HttpConnection.stop("+n+") ignored because the connection is already in the disconnected state."),[2,Promise.resolve()]):this.connectionState==="Disconnecting"?(this.logger.log(ILogger_1.LogLevel.Debug,"Call to HttpConnection.stop("+n+") ignored because the connection is already in the disconnecting state."),[2,this.stopPromise]):(this.connectionState="Disconnecting",this.stopPromise=new Promise(function(n){t.stopPromiseResolver=n}),[4,this.stopInternal(n)]);case 1:return i.sent(),[4,this.stopPromise];case 2:return i.sent(),[2]}})})},n.prototype.stopInternal=function(n){return __awaiter(this,void 0,void 0,function(){var i,t;return __generator(this,function(r){switch(r.label){case 0:this.stopError=n;r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.startInternalPromise];case 2:return r.sent(),[3,4];case 3:return i=r.sent(),[3,4];case 4:if(!this.transport)return[3,9];r.label=5;case 5:return r.trys.push([5,7,,8]),[4,this.transport.stop()];case 6:return r.sent(),[3,8];case 7:return t=r.sent(),this.logger.log(ILogger_1.LogLevel.Error,"HttpConnection.transport.stop() threw error '"+t+"'."),this.stopConnection(),[3,8];case 8:return this.transport=undefined,[3,10];case 9:this.logger.log(ILogger_1.LogLevel.Debug,"HttpConnection.transport is undefined in HttpConnection.stop() because start() failed.");this.stopConnection();r.label=10;case 10:return[2]}})})},n.prototype.startInternal=function(n){return __awaiter(this,void 0,void 0,function(){var i,t,u,e,r,f;return __generator(this,function(o){switch(o.label){case 0:i=this.baseUrl;this.accessTokenFactory=this.options.accessTokenFactory;o.label=1;case 1:return(o.trys.push([1,12,,13]),!this.options.skipNegotiation)?[3,5]:(this.options.transport===ITransport_1.HttpTransportType.WebSockets)?(this.transport=this.constructTransport(ITransport_1.HttpTransportType.WebSockets),[4,this.startTransport(i,n)]):[3,3];case 2:return o.sent(),[3,4];case 3:throw new Error("Negotiation can only be skipped when using the WebSocket transport directly.");case 4:return[3,11];case 5:t=null;u=0;e=function(){var n;return __generator(this,function(f){switch(f.label){case 0:return[4,r.getNegotiationResponse(i)];case 1:if(t=f.sent(),r.connectionState==="Disconnecting"||r.connectionState==="Disconnected")throw new Error("The connection was stopped during negotiation.");if(t.error)throw new Error(t.error);if(t.ProtocolVersion)throw new Error("Detected a connection attempt to an ASP.NET SignalR Server. This client only supports connecting to an ASP.NET Core SignalR Server. See https://aka.ms/signalr-core-differences for details.");return t.url&&(i=t.url),t.accessToken&&(n=t.accessToken,r.accessTokenFactory=function(){return n}),u++,[2]}})};r=this;o.label=6;case 6:return[5,e()];case 7:o.sent();o.label=8;case 8:if(t.url&&u<MAX_REDIRECTS)return[3,6];o.label=9;case 9:if(u===MAX_REDIRECTS&&t.url)throw new Error("Negotiate redirection limit exceeded.");return[4,this.createTransport(i,this.options.transport,t,n)];case 10:o.sent();o.label=11;case 11:return this.transport instanceof LongPollingTransport_1.LongPollingTransport&&(this.features.inherentKeepAlive=!0),this.connectionState==="Connecting"&&(this.logger.log(ILogger_1.LogLevel.Debug,"The HttpConnection connected successfully."),this.connectionState="Connected"),[3,13];case 12:return f=o.sent(),this.logger.log(ILogger_1.LogLevel.Error,"Failed to start the connection: "+f),this.connectionState="Disconnected",this.transport=undefined,[2,Promise.reject(f)];case 13:return[2]}})})},n.prototype.getNegotiationResponse=function(n){return __awaiter(this,void 0,void 0,function(){var i,u,f,s,h,e,r,t,o;return __generator(this,function(c){switch(c.label){case 0:return(i={},!this.accessTokenFactory)?[3,2]:[4,this.accessTokenFactory()];case 1:u=c.sent();u&&(i.Authorization="Bearer "+u);c.label=2;case 2:f=Utils_1.getUserAgentHeader();s=f[0];h=f[1];i[s]=h;e=this.resolveNegotiateUrl(n);this.logger.log(ILogger_1.LogLevel.Debug,"Sending negotiation request: "+e+".");c.label=3;case 3:return c.trys.push([3,5,,6]),[4,this.httpClient.post(e,{content:"",headers:__assign({},i,this.options.headers),withCredentials:this.options.withCredentials})];case 4:return(r=c.sent(),r.statusCode!==200)?[2,Promise.reject(new Error("Unexpected status code returned from negotiate '"+r.statusCode+"'"))]:(t=JSON.parse(r.content),(!t.negotiateVersion||t.negotiateVersion<1)&&(t.connectionToken=t.connectionId),[2,t]);case 5:return o=c.sent(),this.logger.log(ILogger_1.LogLevel.Error,"Failed to complete negotiation with the server: "+o),[2,Promise.reject(o)];case 6:return[2]}})})},n.prototype.createConnectUrl=function(n,t){return t?n+(n.indexOf("?")===-1?"?":"&")+("id="+t):n},n.prototype.createTransport=function(n,t,i,r){return __awaiter(this,void 0,void 0,function(){var s,f,v,u,h,c,e,o,y,l,a;return __generator(this,function(p){switch(p.label){case 0:return(s=this.createConnectUrl(n,i.connectionToken),!this.isITransport(t))?[3,2]:(this.logger.log(ILogger_1.LogLevel.Debug,"Connection was provided an instance of ITransport, using that directly."),this.transport=t,[4,this.startTransport(s,r)]);case 1:return p.sent(),this.connectionId=i.connectionId,[2];case 2:f=[];v=i.availableTransports||[];u=i;h=0;c=v;p.label=3;case 3:return(h<c.length)?(e=c[h],o=this.resolveTransportOrError(e,t,r),!(o instanceof Error))?[3,4]:(f.push(e.transport+" failed: "+o),[3,12]):[3,13];case 4:if(!this.isITransport(o))return[3,12];if(this.transport=o,!!u)return[3,9];p.label=5;case 5:return p.trys.push([5,7,,8]),[4,this.getNegotiationResponse(n)];case 6:return u=p.sent(),[3,8];case 7:return y=p.sent(),[2,Promise.reject(y)];case 8:s=this.createConnectUrl(n,u.connectionToken);p.label=9;case 9:return p.trys.push([9,11,,12]),[4,this.startTransport(s,r)];case 10:return p.sent(),this.connectionId=u.connectionId,[2];case 11:return(l=p.sent(),this.logger.log(ILogger_1.LogLevel.Error,"Failed to start the transport '"+e.transport+"': "+l),u=undefined,f.push(e.transport+" failed: "+l),this.connectionState!=="Connecting")?(a="Failed to select transport before stop() was called.",this.logger.log(ILogger_1.LogLevel.Debug,a),[2,Promise.reject(new Error(a))]):[3,12];case 12:return h++,[3,3];case 13:return f.length>0?[2,Promise.reject(new Error("Unable to connect to the server with any of the available transports. "+f.join(" ")))]:[2,Promise.reject(new Error("None of the transports supported by the client are supported by the server."))]}})})},n.prototype.constructTransport=function(n){switch(n){case ITransport_1.HttpTransportType.WebSockets:if(!this.options.WebSocket)throw new Error("'WebSocket' is not supported in your environment.");return new WebSocketTransport_1.WebSocketTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.WebSocket,this.options.headers||{});case ITransport_1.HttpTransportType.ServerSentEvents:if(!this.options.EventSource)throw new Error("'EventSource' is not supported in your environment.");return new ServerSentEventsTransport_1.ServerSentEventsTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.EventSource,this.options.withCredentials,this.options.headers||{});case ITransport_1.HttpTransportType.LongPolling:return new LongPollingTransport_1.LongPollingTransport(this.httpClient,this.accessTokenFactory,this.logger,this.options.logMessageContent||!1,this.options.withCredentials,this.options.headers||{});default:throw new Error("Unknown transport: "+n+".");}},n.prototype.startTransport=function(n,t){var i=this;return this.transport.onreceive=this.onreceive,this.transport.onclose=function(n){return i.stopConnection(n)},this.transport.connect(n,t)},n.prototype.resolveTransportOrError=function(n,t,i){var r=ITransport_1.HttpTransportType[n.transport],u;if(r===null||r===undefined)return this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+n.transport+"' because it is not supported by this client."),new Error("Skipping transport '"+n.transport+"' because it is not supported by this client.");if(transportMatches(t,r))if(u=n.transferFormats.map(function(n){return ITransport_1.TransferFormat[n]}),u.indexOf(i)>=0)if((r!==ITransport_1.HttpTransportType.WebSockets||this.options.WebSocket)&&(r!==ITransport_1.HttpTransportType.ServerSentEvents||this.options.EventSource)){this.logger.log(ILogger_1.LogLevel.Debug,"Selecting transport '"+ITransport_1.HttpTransportType[r]+"'.");try{return this.constructTransport(r)}catch(f){return f}}else return this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+ITransport_1.HttpTransportType[r]+"' because it is not supported in your environment.'"),new Error("'"+ITransport_1.HttpTransportType[r]+"' is not supported in your environment.");else return this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+ITransport_1.HttpTransportType[r]+"' because it does not support the requested transfer format '"+ITransport_1.TransferFormat[i]+"'."),new Error("'"+ITransport_1.HttpTransportType[r]+"' does not support "+ITransport_1.TransferFormat[i]+".");else return this.logger.log(ILogger_1.LogLevel.Debug,"Skipping transport '"+ITransport_1.HttpTransportType[r]+"' because it was disabled by the client."),new Error("'"+ITransport_1.HttpTransportType[r]+"' is disabled by the client.")},n.prototype.isITransport=function(n){return n&&typeof n=="object"&&"connect"in n},n.prototype.stopConnection=function(n){var t=this;if(this.logger.log(ILogger_1.LogLevel.Debug,"HttpConnection.stopConnection("+n+") called while in state "+this.connectionState+"."),this.transport=undefined,n=this.stopError||n,this.stopError=undefined,this.connectionState==="Disconnected"){this.logger.log(ILogger_1.LogLevel.Debug,"Call to HttpConnection.stopConnection("+n+") was ignored because the connection is already in the disconnected state.");return}if(this.connectionState==="Connecting"){this.logger.log(ILogger_1.LogLevel.Warning,"Call to HttpConnection.stopConnection("+n+") was ignored because the connection is still in the connecting state.");throw new Error("HttpConnection.stopConnection("+n+") was called while the connection is still in the connecting state.");}if(this.connectionState==="Disconnecting"&&this.stopPromiseResolver(),n?this.logger.log(ILogger_1.LogLevel.Error,"Connection disconnected with error '"+n+"'."):this.logger.log(ILogger_1.LogLevel.Information,"Connection disconnected."),this.sendQueue&&(this.sendQueue.stop().catch(function(n){t.logger.log(ILogger_1.LogLevel.Error,"TransportSendQueue.stop() threw error '"+n+"'.")}),this.sendQueue=undefined),this.connectionId=undefined,this.connectionState="Disconnected",this.connectionStarted){this.connectionStarted=!1;try{if(this.onclose)this.onclose(n)}catch(i){this.logger.log(ILogger_1.LogLevel.Error,"HttpConnection.onclose("+n+") threw error '"+i+"'.")}}},n.prototype.resolveUrl=function(n){if(n.lastIndexOf("https://",0)===0||n.lastIndexOf("http://",0)===0)return n;if(!Utils_1.Platform.isBrowser||!window.document)throw new Error("Cannot resolve '"+n+"'.");var t=window.document.createElement("a");return t.href=n,this.logger.log(ILogger_1.LogLevel.Information,"Normalizing '"+n+"' to '"+t.href+"'."),t.href},n.prototype.resolveNegotiateUrl=function(n){var i=n.indexOf("?"),t=n.substring(0,i===-1?n.length:i);return t[t.length-1]!=="/"&&(t+="/"),t+="negotiate",t+=i===-1?"":n.substring(i),t.indexOf("negotiateVersion")===-1&&(t+=i===-1?"?":"&",t+="negotiateVersion="+this.negotiateVersion),t},n}();exports.HttpConnection=HttpConnection;TransportSendQueue=function(){function n(n){this.transport=n;this.buffer=[];this.executing=!0;this.sendBufferedData=new PromiseSource;this.transportResult=new PromiseSource;this.sendLoopPromise=this.sendLoop()}return n.prototype.send=function(n){return this.bufferData(n),this.transportResult||(this.transportResult=new PromiseSource),this.transportResult.promise},n.prototype.stop=function(){return this.executing=!1,this.sendBufferedData.resolve(),this.sendLoopPromise},n.prototype.bufferData=function(n){if(this.buffer.length&&typeof this.buffer[0]!=typeof n)throw new Error("Expected data to be of type "+typeof this.buffer+" but was of type "+typeof n);this.buffer.push(n);this.sendBufferedData.resolve()},n.prototype.sendLoop=function(){return __awaiter(this,void 0,void 0,function(){var t,i,r;return __generator(this,function(u){switch(u.label){case 0:return[4,this.sendBufferedData.promise];case 1:if(u.sent(),!this.executing)return this.transportResult&&this.transportResult.reject("Connection stopped."),[3,6];this.sendBufferedData=new PromiseSource;t=this.transportResult;this.transportResult=undefined;i=typeof this.buffer[0]=="string"?this.buffer.join(""):n.concatBuffers(this.buffer);this.buffer.length=0;u.label=2;case 2:return u.trys.push([2,4,,5]),[4,this.transport.send(i)];case 3:return u.sent(),t.resolve(),[3,5];case 4:return r=u.sent(),t.reject(r),[3,5];case 5:return[3,0];case 6:return[2]}})})},n.concatBuffers=function(n){for(var i,e=n.map(function(n){return n.byteLength}).reduce(function(n,t){return n+t}),r=new Uint8Array(e),u=0,t=0,f=n;t<f.length;t++)i=f[t],r.set(new Uint8Array(i),u),u+=i.byteLength;return r.buffer},n}();exports.TransportSendQueue=TransportSendQueue;PromiseSource=function(){function n(){var n=this;this.promise=new Promise(function(t,i){var r;return r=[t,i],n.resolver=r[0],n.rejecter=r[1],r})}return n.prototype.resolve=function(){this.resolver()},n.prototype.reject=function(n){this.rejecter(n)},n}();